import{s as y}from"./index-C6d_FyIB.js";function P(n,l,e){const{p1:s,p2:p}=n,{p3:d,p4:r}=l,_=(s.rating+p.rating)/2,g=(d.rating+r.rating)/2;if(Math.abs(_-g)>1)return{skipped:!0,message:"Disparidade demasiado alta (>"+Math.abs(_-g).toFixed(2)+"), nível inalterado"};const M=1/(1+Math.pow(10,(g-_)/2)),w=e.sets1>e.sets2?1:e.sets1<e.sets2?0:.5;let f=1;const o=Math.abs(e.gamesTotal1-e.gamesTotal2);e.sets1+e.sets2===3?f=.6:o>8&&(f=1.3);const C=$=>$<10?.15:$<50?.08:.04,m=($,t,q,j)=>{const D=C($.matches)*(t-q)*j;return parseFloat(D.toFixed(4))},v=m(s,w,M,f),R=m(p,w,M,f),E=m(d,1-w,1-M,f),x=m(r,1-w,1-M,f),b=$=>Math.max(.5,Math.min(7,parseFloat($.toFixed(2))));return{team1:{p1:{...s,rating:b(s.rating+v),delta:v,matches:s.matches+1},p2:{...p,rating:b(p.rating+R),delta:R,matches:p.matches+1}},team2:{p3:{...d,rating:b(d.rating+E),delta:E,matches:d.matches+1},p4:{...r,rating:b(r.rating+x),delta:x,matches:r.matches+1}}}}function k(n){return n<=0?0:n>=75?100:Math.min(100,Math.round(100*(Math.log(n+1)/Math.log(76))))}function ee(n){if(n<=0)return 0;if(n>=100)return 75;const l=Math.round(Math.exp(n/100*Math.log(76))-1);return Math.max(0,Math.min(75,l))}async function te(n,l){var q,j,T,D,N,S,U,B,K,L,O,G,H,J,Q,V;const{data:e,error:s}=await y.from("matches").select(`
      id, team1_id, team2_id, status,
      team1_score_set1, team2_score_set1,
      team1_score_set2, team2_score_set2,
      team1_score_set3, team2_score_set3,
      player1_individual_id, player2_individual_id,
      player3_individual_id, player4_individual_id
    `).eq("id",n).single();if(s||!e)return console.error("[RatingEngine] Match not found:",n,s),null;if(e.status!=="completed")return console.log("[RatingEngine] Match not completed, skipping:",n),null;const p=[e.team1_score_set1??0,e.team2_score_set1??0],d=[e.team1_score_set2??0,e.team2_score_set2??0],r=[e.team1_score_set3??0,e.team2_score_set3??0],_=(p[0]>p[1]?1:0)+(d[0]>d[1]?1:0)+(r[0]>r[1]?1:0),g=(p[1]>p[0]?1:0)+(d[1]>d[0]?1:0)+(r[1]>r[0]?1:0),M=p[0]+d[0]+r[0],w=p[1]+d[1]+r[1];if(_===0&&g===0)return console.log("[RatingEngine] No sets played, skipping:",n),null;const f={sets1:_,sets2:g,gamesTotal1:M,gamesTotal2:w};let o=[];if(e.player1_individual_id||e.player2_individual_id)o=[e.player1_individual_id,e.player2_individual_id,e.player3_individual_id,e.player4_individual_id].filter(Boolean);else if(e.team1_id&&e.team2_id){const{data:c}=await y.from("teams").select("id, player1_id, player2_id").in("id",[e.team1_id,e.team2_id]);if(!c||c.length<2)return console.error("[RatingEngine] Could not find teams for match:",n),null;const i=c.find(F=>F.id===e.team1_id),a=c.find(F=>F.id===e.team2_id);o=[i==null?void 0:i.player1_id,i==null?void 0:i.player2_id,a==null?void 0:a.player1_id,a==null?void 0:a.player2_id].filter(Boolean)}if(o.length<4)return console.log("[RatingEngine] Less than 4 players found, skipping:",n,"found:",o.length),null;const{data:m}=await y.from("players").select("id, name, phone_number, user_id").in("id",o);if(!m||m.length<4)return console.log("[RatingEngine] Could not fetch all player entries:",n),null;const v=new Map;for(const c of m){let i=null;if(c.user_id){const{data:a}=await y.from("player_accounts").select("id, user_id, name, level, wins, losses, level_reliability_percent").eq("user_id",c.user_id).maybeSingle();a&&(i=a)}if(!i&&c.phone_number){const{data:a}=await y.from("player_accounts").select("id, user_id, name, level, wins, losses, level_reliability_percent").eq("phone_number",c.phone_number).maybeSingle();a&&(i=a)}if(!i&&c.name){const{data:a}=await y.from("player_accounts").select("id, user_id, name, level, wins, losses, level_reliability_percent").ilike("name",c.name).maybeSingle();a&&(i=a)}i&&v.set(c.id,i)}if(v.size<4)return console.log("[RatingEngine] Could not map all players to accounts:",n,"mapped:",v.size),null;const R=c=>{const i=v.get(c);if(!i)return null;const a=l==null?void 0:l.get(i.id);return a?{id:a.id,user_id:a.user_id,name:a.name,rating:a.rating,matches:a.matchCount}:{id:i.id,user_id:i.user_id||"",name:i.name||"",rating:i.level??3,matches:(i.wins??0)+(i.losses??0)}},E=R(o[0]),x=R(o[1]),b=R(o[2]),$=R(o[3]);if(!E||!x||!b||!$)return console.log("[RatingEngine] Could not build all player ratings"),null;const t=P({p1:E,p2:x},{p3:b,p4:$},f);if(t.skipped)return console.log("[RatingEngine] Match skipped:",t.message),t;if(t.team1&&t.team2){const c=[t.team1.p1,t.team1.p2,t.team2.p3,t.team2.p4];for(const u of c){const{data:h}=await y.from("player_accounts").select("wins, losses, level_reliability_percent").eq("id",u.id).single();let z;if((h==null?void 0:h.level_reliability_percent)!=null&&h.level_reliability_percent>0){const I=ee(h.level_reliability_percent)+1;z=k(I)}else{const A=((h==null?void 0:h.wins)??0)+((h==null?void 0:h.losses)??0)+1;z=k(A)}l&&l.set(u.id,{id:u.id,user_id:u.user_id,name:u.name,rating:u.rating,matchCount:u.matches});const{error:Z}=await y.rpc("update_player_rating",{p_player_account_id:u.id,p_new_level:u.rating,p_new_reliability:z});Z&&console.error("[RatingEngine] Error updating player:",u.id,Z)}const{error:i}=await y.rpc("mark_match_rating_processed",{p_match_id:n});i&&console.error("[RatingEngine] Error marking match as processed:",n,i);const a=await Promise.all([t.team1.p1,t.team1.p2,t.team2.p3,t.team2.p4].map(u=>y.from("player_accounts").select("wins, losses").eq("id",u.id).single()));console.log("[RatingEngine] Updated ratings for match:",n);const F=(((j=(q=a[0])==null?void 0:q.data)==null?void 0:j.wins)??0)+(((D=(T=a[0])==null?void 0:T.data)==null?void 0:D.losses)??0),W=(((S=(N=a[1])==null?void 0:N.data)==null?void 0:S.wins)??0)+(((B=(U=a[1])==null?void 0:U.data)==null?void 0:B.losses)??0),X=(((L=(K=a[2])==null?void 0:K.data)==null?void 0:L.wins)??0)+(((G=(O=a[2])==null?void 0:O.data)==null?void 0:G.losses)??0),Y=(((J=(H=a[3])==null?void 0:H.data)==null?void 0:J.wins)??0)+(((V=(Q=a[3])==null?void 0:Q.data)==null?void 0:V.losses)??0);console.log(`  ${t.team1.p1.name}: ${E.rating.toFixed(2)} → ${t.team1.p1.rating.toFixed(2)} (${t.team1.p1.delta>0?"+":""}${t.team1.p1.delta.toFixed(4)}) | jogos: ${F} | fiab: ${k(F)}%`),console.log(`  ${t.team1.p2.name}: ${x.rating.toFixed(2)} → ${t.team1.p2.rating.toFixed(2)} (${t.team1.p2.delta>0?"+":""}${t.team1.p2.delta.toFixed(4)}) | jogos: ${W} | fiab: ${k(W)}%`),console.log(`  ${t.team2.p3.name}: ${b.rating.toFixed(2)} → ${t.team2.p3.rating.toFixed(2)} (${t.team2.p3.delta>0?"+":""}${t.team2.p3.delta.toFixed(4)}) | jogos: ${X} | fiab: ${k(X)}%`),console.log(`  ${t.team2.p4.name}: ${$.rating.toFixed(2)} → ${t.team2.p4.rating.toFixed(2)} (${t.team2.p4.delta>0?"+":""}${t.team2.p4.delta.toFixed(4)}) | jogos: ${Y} | fiab: ${k(Y)}%`)}return t}async function ie(n,l){let e=y.from("matches").select("id, scheduled_time, tournament_id").eq("status","completed").or("rating_processed.is.null,rating_processed.eq.false").order("scheduled_time",{ascending:!0});n&&(e=e.gte("scheduled_time",n));const{data:s,error:p}=await e;if(p)return console.error("[RatingEngine] Error fetching matches:",p),{processed:0,skipped:0,errors:1,total:0};if(!s||s.length===0)return console.log("[RatingEngine] No matches to process"),{processed:0,skipped:0,errors:0,total:0};console.log(`[RatingEngine] Found ${s.length} completed matches to process`),l==null||l(0,s.length,"A iniciar processamento...");const d=new Map;let r=0,_=0,g=0;for(let o=0;o<s.length;o++){const C=s[o];try{const m=await te(C.id,d);m?m.skipped?_++:r++:g++}catch(m){console.error("[RatingEngine] Error processing match:",C.id,m),g++}((o+1)%5===0||o===s.length-1)&&(l==null||l(o+1,s.length,`Processados: ${r} | Saltados: ${_} | Erros: ${g}`))}const M=d.size,w=Math.max(0,...Array.from(d.values()).map(o=>o.matchCount)),f=`CONCLUÍDO: ${r} processados, ${_} saltados, ${g} erros de ${s.length} total | ${M} jogadores atualizados (max ${w} jogos rated)`;return console.log(`[RatingEngine] ${f}`),l==null||l(s.length,s.length,f),{processed:r,skipped:_,errors:g,total:s.length}}export{ee as calculateMatchesFromReliability,P as calculateNewRatings,k as calculateReliability,ie as processAllUnratedMatches,te as processMatchRating};
