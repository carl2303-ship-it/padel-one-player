import{s as v}from"./index-DDnPlDw7.js";function k(l,o,a){const{p1:n,p2:m}=l,{p3:c,p4:d}=o,g=(n.rating+m.rating)/2,u=(c.rating+d.rating)/2;if(Math.abs(g-u)>1)return{skipped:!0,message:"Disparidade demasiado alta (>"+Math.abs(g-u).toFixed(2)+"), nível inalterado"};const h=1/(1+Math.pow(10,(u-g)/2)),y=a.sets1>a.sets2?1:a.sets1<a.sets2?0:.5;let _=1;const s=Math.abs(a.gamesTotal1-a.gamesTotal2);a.sets1+a.sets2===3?_=.6:s>8&&(_=1.3);const w=f=>f<10?.15:f<50?.08:.04,p=(f,e,r,t)=>{const b=w(f.matches)*(e-r)*t;return parseFloat(b.toFixed(4))},x=p(n,y,h,_),E=p(m,y,h,_),R=p(c,1-y,1-h,_),F=p(d,1-y,1-h,_),$=f=>Math.max(.5,Math.min(7,parseFloat(f.toFixed(2))));return{team1:{p1:{...n,rating:$(n.rating+x),delta:x,matches:n.matches+1},p2:{...m,rating:$(m.rating+E),delta:E,matches:m.matches+1}},team2:{p3:{...c,rating:$(c.rating+R),delta:R,matches:c.matches+1},p4:{...d,rating:$(d.rating+F),delta:F,matches:d.matches+1}}}}function M(l){return l<=0?0:l>=75?100:Math.min(100,Math.round(100*(Math.log(l+1)/Math.log(76))))}async function C(l,o){const{data:a,error:n}=await v.from("matches").select(`
      id, team1_id, team2_id, status,
      team1_score_set1, team2_score_set1,
      team1_score_set2, team2_score_set2,
      team1_score_set3, team2_score_set3,
      player1_individual_id, player2_individual_id,
      player3_individual_id, player4_individual_id
    `).eq("id",l).single();if(n||!a)return console.error("[RatingEngine] Match not found:",l,n),null;if(a.status!=="completed")return console.log("[RatingEngine] Match not completed, skipping:",l),null;const m=[a.team1_score_set1??0,a.team2_score_set1??0],c=[a.team1_score_set2??0,a.team2_score_set2??0],d=[a.team1_score_set3??0,a.team2_score_set3??0],g=(m[0]>m[1]?1:0)+(c[0]>c[1]?1:0)+(d[0]>d[1]?1:0),u=(m[1]>m[0]?1:0)+(c[1]>c[0]?1:0)+(d[1]>d[0]?1:0),h=m[0]+c[0]+d[0],y=m[1]+c[1]+d[1];if(g===0&&u===0)return console.log("[RatingEngine] No sets played, skipping:",l),null;const _={sets1:g,sets2:u,gamesTotal1:h,gamesTotal2:y};let s=[];if(a.player1_individual_id||a.player2_individual_id)s=[a.player1_individual_id,a.player2_individual_id,a.player3_individual_id,a.player4_individual_id].filter(Boolean);else if(a.team1_id&&a.team2_id){const{data:r}=await v.from("teams").select("id, player1_id, player2_id").in("id",[a.team1_id,a.team2_id]);if(!r||r.length<2)return console.error("[RatingEngine] Could not find teams for match:",l),null;const t=r.find(b=>b.id===a.team1_id),i=r.find(b=>b.id===a.team2_id);s=[t==null?void 0:t.player1_id,t==null?void 0:t.player2_id,i==null?void 0:i.player1_id,i==null?void 0:i.player2_id].filter(Boolean)}if(s.length<4)return console.log("[RatingEngine] Less than 4 players found, skipping:",l,"found:",s.length),null;const{data:p}=await v.from("players").select("id, name, phone_number, user_id").in("id",s);if(!p||p.length<4)return console.log("[RatingEngine] Could not fetch all player entries:",l),null;const x=new Map;for(const r of p){let t=null;if(r.user_id){const{data:i}=await v.from("player_accounts").select("id, user_id, name, level, wins, losses, level_reliability_percent").eq("user_id",r.user_id).maybeSingle();i&&(t=i)}if(!t&&r.phone_number){const{data:i}=await v.from("player_accounts").select("id, user_id, name, level, wins, losses, level_reliability_percent").eq("phone_number",r.phone_number).maybeSingle();i&&(t=i)}if(!t&&r.name){const{data:i}=await v.from("player_accounts").select("id, user_id, name, level, wins, losses, level_reliability_percent").ilike("name",r.name).maybeSingle();i&&(t=i)}t&&x.set(r.id,t)}if(x.size<4)return console.log("[RatingEngine] Could not map all players to accounts:",l,"mapped:",x.size),null;const E=r=>{const t=x.get(r);if(!t)return null;const i=o==null?void 0:o.get(t.id);return i?{id:i.id,user_id:i.user_id,name:i.name,rating:i.rating,matches:i.matchCount}:{id:t.id,user_id:t.user_id||"",name:t.name||"",rating:t.level??3,matches:(t.wins??0)+(t.losses??0)}},R=E(s[0]),F=E(s[1]),$=E(s[2]),f=E(s[3]);if(!R||!F||!$||!f)return console.log("[RatingEngine] Could not build all player ratings"),null;const e=k({p1:R,p2:F},{p3:$,p4:f},_);if(e.skipped)return console.log("[RatingEngine] Match skipped:",e.message),e;if(e.team1&&e.team2){const r=[e.team1.p1,e.team1.p2,e.team2.p3,e.team2.p4];for(const t of r){const i=M(t.matches);o&&o.set(t.id,{id:t.id,user_id:t.user_id,name:t.name,rating:t.rating,matchCount:t.matches});const{error:b}=await v.from("player_accounts").update({level:t.rating,level_reliability_percent:i}).eq("id",t.id);b&&console.error("[RatingEngine] Error updating player:",t.id,b)}console.log("[RatingEngine] Updated ratings for match:",l),console.log(`  ${e.team1.p1.name}: ${R.rating.toFixed(2)} → ${e.team1.p1.rating.toFixed(2)} (${e.team1.p1.delta>0?"+":""}${e.team1.p1.delta.toFixed(4)}) | jogos: ${e.team1.p1.matches} | fiab: ${M(e.team1.p1.matches)}%`),console.log(`  ${e.team1.p2.name}: ${F.rating.toFixed(2)} → ${e.team1.p2.rating.toFixed(2)} (${e.team1.p2.delta>0?"+":""}${e.team1.p2.delta.toFixed(4)}) | jogos: ${e.team1.p2.matches} | fiab: ${M(e.team1.p2.matches)}%`),console.log(`  ${e.team2.p3.name}: ${$.rating.toFixed(2)} → ${e.team2.p3.rating.toFixed(2)} (${e.team2.p3.delta>0?"+":""}${e.team2.p3.delta.toFixed(4)}) | jogos: ${e.team2.p3.matches} | fiab: ${M(e.team2.p3.matches)}%`),console.log(`  ${e.team2.p4.name}: ${f.rating.toFixed(2)} → ${e.team2.p4.rating.toFixed(2)} (${e.team2.p4.delta>0?"+":""}${e.team2.p4.delta.toFixed(4)}) | jogos: ${e.team2.p4.matches} | fiab: ${M(e.team2.p4.matches)}%`)}return e}async function j(l,o){let a=v.from("matches").select("id, scheduled_time, tournament_id").eq("status","completed").order("scheduled_time",{ascending:!0});l&&(a=a.gte("scheduled_time",l));const{data:n,error:m}=await a;if(m)return console.error("[RatingEngine] Error fetching matches:",m),{processed:0,skipped:0,errors:1,total:0};if(!n||n.length===0)return console.log("[RatingEngine] No matches to process"),{processed:0,skipped:0,errors:0,total:0};console.log(`[RatingEngine] Found ${n.length} completed matches to process`),o==null||o(0,n.length,"A iniciar processamento...");const c=new Map;let d=0,g=0,u=0;for(let s=0;s<n.length;s++){const w=n[s];try{const p=await C(w.id,c);p?p.skipped?g++:d++:u++}catch(p){console.error("[RatingEngine] Error processing match:",w.id,p),u++}((s+1)%5===0||s===n.length-1)&&(o==null||o(s+1,n.length,`Processados: ${d} | Saltados: ${g} | Erros: ${u}`))}const h=c.size,y=Math.max(0,...Array.from(c.values()).map(s=>s.matchCount)),_=`CONCLUÍDO: ${d} processados, ${g} saltados, ${u} erros de ${n.length} total | ${h} jogadores atualizados (max ${y} jogos rated)`;return console.log(`[RatingEngine] ${_}`),o==null||o(n.length,n.length,_),{processed:d,skipped:g,errors:u,total:n.length}}export{k as calculateNewRatings,M as calculateReliability,j as processAllUnratedMatches,C as processMatchRating};
