import{s as n}from"./index-D_NLApbw.js";async function z(e){let r=n.from("open_games").select("*").in("status",["open","full"]).gte("scheduled_at",new Date().toISOString()).order("scheduled_at",{ascending:!0});e!=null&&e.clubId&&(r=r.eq("club_id",e.clubId)),e!=null&&e.dateFrom&&(r=r.gte("scheduled_at",e.dateFrom)),e!=null&&e.dateTo&&(r=r.lte("scheduled_at",e.dateTo));const{data:s,error:_}=await r;if(_)return console.error("[OpenGames] Error fetching games:",_),[];if(!s||s.length===0)return[];const d=s.map(t=>t.id),{data:o}=await n.from("open_game_players").select("*").in("game_id",d).in("status",["confirmed","pending"]),a=[...new Set((o||[]).map(t=>t.user_id))],m=[...new Set((o||[]).map(t=>t.player_account_id).filter(Boolean))];let l={};if(a.length>0){const{data:t}=await n.from("player_accounts").select("id, user_id, name, avatar_url, level, player_category").in("user_id",a);t&&t.forEach(i=>{l[i.user_id]={name:i.name,avatar_url:i.avatar_url,level:i.level,player_category:i.player_category},l["pa_"+i.id]=l[i.user_id]})}const y=m.filter(t=>!l["pa_"+t]);if(y.length>0){const{data:t}=await n.from("player_accounts").select("id, user_id, name, avatar_url, level, player_category").in("id",y);t&&t.forEach(i=>{l[i.user_id]||(l[i.user_id]={name:i.name,avatar_url:i.avatar_url,level:i.level,player_category:i.player_category}),l["pa_"+i.id]={name:i.name,avatar_url:i.avatar_url,level:i.level,player_category:i.player_category}})}const g=[...new Set(s.map(t=>t.club_id))];let c={};if(g.length>0){const{data:t}=await n.from("clubs").select("id, name, logo_url, city").in("id",g);t&&t.forEach(i=>{c[i.id]={name:i.name,logo_url:i.logo_url,city:i.city}})}const u=[...new Set(s.map(t=>t.court_id).filter(Boolean))];let f={};if(u.length>0){const{data:t}=await n.from("club_courts").select("id, name, type").in("id",u);t&&t.forEach(i=>{f[i.id]={name:i.name,type:i.type||null}})}const p=s.map(t=>{const i=(o||[]).filter(w=>w.game_id===t.id).map(w=>{const b=(w.player_account_id?l["pa_"+w.player_account_id]:null)||l[w.user_id];return{id:w.id,user_id:w.user_id,player_account_id:w.player_account_id,status:w.status,position:w.position,name:(b==null?void 0:b.name)||"Jogador",avatar_url:(b==null?void 0:b.avatar_url)||null,level:(b==null?void 0:b.level)||null,player_category:(b==null?void 0:b.player_category)||null}}),v=c[t.club_id]||{name:"Clube",logo_url:null,city:null},I=t.court_id?f[t.court_id]:null;return{id:t.id,creator_user_id:t.creator_user_id,club_id:t.club_id,club_name:v.name,club_logo_url:v.logo_url,club_city:v.city,court_id:t.court_id,court_name:(I==null?void 0:I.name)||null,court_type:(I==null?void 0:I.type)||null,scheduled_at:t.scheduled_at,duration_minutes:t.duration_minutes,game_type:t.game_type,gender:t.gender,level_min:parseFloat(t.level_min)||1,level_max:parseFloat(t.level_max)||7,price_per_player:parseFloat(t.price_per_player)||0,max_players:t.max_players,status:t.status,notes:t.notes,players:i,created_at:t.created_at}});return e!=null&&e.timeFrom||e!=null&&e.timeTo?p.filter(t=>{const i=new Date(t.scheduled_at).getHours(),v=e!=null&&e.timeFrom?parseInt(e.timeFrom.split(":")[0]):0,I=e!=null&&e.timeTo?parseInt(e.timeTo.split(":")[0]):24;return i>=v&&i<I}):p}async function B(){const{data:e,error:r}=await n.from("clubs").select("id, owner_id, name, logo_url, city, address").eq("is_active",!0).order("name");if(r||!e||e.length===0)return console.error("[OpenGames] Error fetching clubs:",r),[];const s=[];for(const _ of e){const{data:d}=await n.from("club_courts").select("id, name, type, hourly_rate, peak_rate").eq("user_id",_.owner_id).eq("is_active",!0).order("name");if(!d||d.length===0)continue;const{data:o}=await n.from("user_logo_settings").select("booking_start_time, booking_end_time, booking_slot_duration, max_advance_days").eq("user_id",_.owner_id).maybeSingle(),a=(o==null?void 0:o.booking_start_time)||"08:00",m=(o==null?void 0:o.booking_end_time)||"22:00",l=(o==null?void 0:o.booking_slot_duration)||90,y=(o==null?void 0:o.max_advance_days)||7,g=[],c=new Date;for(let h=0;h<y;h++){const M=new Date(c);M.setDate(M.getDate()+h),g.push(M.toISOString().split("T")[0])}const u=g[0]+"T00:00:00",f=g[g.length-1]+"T23:59:59",{data:p}=await n.from("court_bookings").select("court_id, start_time, end_time").in("court_id",d.map(h=>h.id)).eq("status","confirmed").gte("start_time",u).lte("start_time",f),{data:t}=await n.from("open_games").select("court_id, scheduled_at, duration_minutes").eq("club_id",_.id).in("status",["open","full"]).gte("scheduled_at",u).lte("scheduled_at",f),i={},v=parseInt(a.split(":")[0]),I=parseInt(a.split(":")[1]||"0"),w=parseInt(m.split(":")[0]),b=parseInt(m.split(":")[1]||"0"),P=v*60+I,$=w*60+b;for(const h of g){const M=[];let E=P;if(h===g[0]){const D=c.getHours()*60+c.getMinutes()+60;if(D>P){const A=D-P,T=Math.ceil(A/l);E=P+T*l}}for(let S=E;S+l<=$;S+=l){const D=Math.floor(S/60),A=S%60,T=`${D.toString().padStart(2,"0")}:${A.toString().padStart(2,"0")}`,O=new Date(`${h}T${T}:00`),G=new Date(O.getTime()+l*6e4),j=new Date(`${h}T${m}:00`);if(G>j)continue;const q=[];for(const k of d)if(U(k.id,O,G,p||[],t||[])){const F=parseFloat(k.hourly_rate)||0,J=Math.round(F*(l/60)/4*100)/100,L=Math.round(F*1/4*100)/100;q.push({court_id:k.id,court_name:k.name,court_type:k.type||null,durations:[l],price_90:J,price_60:L})}q.length>0&&M.push({time:T,courts:q,durations:q[0].durations,court_id:q[0].court_id,court_name:q[0].court_name,price_90:q[0].price_90,price_60:q[0].price_60})}M.length>0&&(i[h]=M)}Object.keys(i).length>0&&s.push({id:_.id,name:_.name,logo_url:_.logo_url,city:_.city,address:_.address,courts:d.map(h=>({id:h.id,name:h.name,hourly_rate:parseFloat(h.hourly_rate)||0,peak_rate:parseFloat(h.peak_rate)||0})),operating_hours:{start:a,end:m},availability:i})}return s}function U(e,r,s,_,d){for(const o of _){if(o.court_id!==e)continue;const a=new Date(o.start_time),m=new Date(o.end_time);if(r<m&&s>a)return!1}for(const o of d){if(o.court_id!==e)continue;const a=new Date(o.scheduled_at),m=new Date(a.getTime()+(o.duration_minutes||90)*6e4);if(r<m&&s>a)return!1}return!0}async function N(e){const{data:{user:r}}=await n.auth.getUser(),s=r==null?void 0:r.id;if(!s)return{success:!1,error:"Utilizador não autenticado"};const _=Math.max(1,e.playerLevel-.5),d=Math.min(7,e.playerLevel+.5),{data:o,error:a}=await n.from("open_games").insert({creator_user_id:s,club_id:e.clubId,court_id:e.courtId,scheduled_at:e.scheduledAt,duration_minutes:e.durationMinutes,game_type:e.gameType,gender:e.gender,level_min:_,level_max:d,price_per_player:e.pricePerPlayer,max_players:4,status:"open"}).select("id").single();if(a||!o)return console.error("[OpenGames] Error creating game:",a),{success:!1,error:(a==null?void 0:a.message)||"Erro ao criar jogo"};const m=e.playerAccountId||null,l=e.playerName||null,y=e.playerPhone||null;let g=m,c=l,u=y;if(!g||!c){const{data:p}=await n.from("player_accounts").select("id, name, phone_number").eq("user_id",e.userId).maybeSingle();p&&(g=g||p.id,c=c||p.name,u=u||p.phone_number)}const{error:f}=await n.from("open_game_players").insert({game_id:o.id,user_id:s,player_account_id:g,status:"confirmed",position:1});f&&console.error("[OpenGames] Error adding creator to game:",f);try{const{data:p}=await n.from("clubs").select("owner_id").eq("id",e.clubId).single();if(p){const t=new Date(new Date(e.scheduledAt).getTime()+e.durationMinutes*6e4),i=e.gameType==="competitive"?"Competitivo":"Amigável",v=c||"Jogador";await n.from("court_bookings").insert({user_id:p.owner_id,court_id:e.courtId,start_time:e.scheduledAt,end_time:t.toISOString(),booked_by_name:v,booked_by_phone:u||null,player1_name:v,player1_phone:u||null,player1_is_member:!1,player1_discount:0,player2_is_member:!1,player2_discount:0,player3_is_member:!1,player3_discount:0,player4_is_member:!1,player4_discount:0,status:"confirmed",price:e.pricePerPlayer*4,payment_status:"pending",event_type:"open_game",notes:`Jogo Aberto (${i}) - Criado pela app Player | ID: ${o.id}`}),await x(o.id)}}catch(p){console.error("[OpenGames] Error syncing court booking:",p)}return{success:!0,gameId:o.id}}async function x(e){try{const{data:r}=await n.from("open_game_players").select("player_account_id, user_id, position").eq("game_id",e).eq("status","confirmed").order("position",{ascending:!0});if(!r)return;const s=r.map(c=>c.player_account_id).filter(Boolean);let _={};if(s.length>0){const{data:c}=await n.from("player_accounts").select("id, name, phone_number").in("id",s);c&&c.forEach(u=>{_[u.id]={name:u.name,phone:u.phone_number}})}const{data:d}=await n.from("open_games").select("club_id, price_per_player").eq("id",e).single();if(!d)return;const{data:o}=await n.from("clubs").select("owner_id").eq("id",d.club_id).single();if(!o)return;const a=[];for(let c=0;c<4;c++){const u=r[c];if(u&&u.player_account_id&&_[u.player_account_id]){const f=_[u.player_account_id];a.push({name:f.name,phone:f.phone||null,isMember:!1,discount:0})}else u?a.push({name:null,phone:null,isMember:!1,discount:0}):a.push({name:null,phone:null,isMember:!1,discount:0})}for(let c=0;c<a.length;c++){const u=a[c];if(!u.name&&!u.phone)continue;const f=u.phone?u.phone.replace(/[\s\-\(\)\.]/g,"").replace(/^00/,"+"):"";let p=n.from("member_subscriptions").select("member_name, member_phone, plan:membership_plans(name, court_discount_percent)").eq("club_owner_id",o.owner_id).eq("status","active");if(f&&f.length>=6)p=p.or(`member_phone.ilike.%${f}%`);else if(u.name&&u.name.length>=2)p=p.ilike("member_name",`%${u.name}%`);else continue;const{data:t}=await p.limit(1).maybeSingle();t&&t.plan&&(a[c].isMember=!0,a[c].discount=t.plan.court_discount_percent||0)}const m=parseFloat(d.price_per_player)||0;let l=0;for(const c of a)if(c.name){const u=m-m*(c.discount/100);l+=u}const y=a.filter(c=>c.name).length;y<4&&(l+=m*(4-y));const g={booked_by_name:a[0].name||"Jogador",booked_by_phone:a[0].phone||null,player1_name:a[0].name||null,player1_phone:a[0].phone||null,player1_is_member:a[0].isMember,player1_discount:a[0].discount,player2_name:a[1].name||null,player2_phone:a[1].phone||null,player2_is_member:a[1].isMember,player2_discount:a[1].discount,player3_name:a[2].name||null,player3_phone:a[2].phone||null,player3_is_member:a[2].isMember,player3_discount:a[2].discount,player4_name:a[3].name||null,player4_phone:a[3].phone||null,player4_is_member:a[3].isMember,player4_discount:a[3].discount,price:l};await n.from("court_bookings").update(g).like("notes",`%ID: ${e}%`).eq("event_type","open_game")}catch(r){console.error("[OpenGames] Error syncing booking players:",r)}}async function R(e){const{data:{user:r}}=await n.auth.getUser(),s=r==null?void 0:r.id;if(!s)return{success:!1,status:"pending",error:"Utilizador não autenticado"};const d=e.playerLevel>=e.gameLevelMin&&e.playerLevel<=e.gameLevelMax?"confirmed":"pending";let o=e.playerAccountId||null;if(!o){const{data:y}=await n.from("player_accounts").select("id").eq("user_id",e.userId).maybeSingle();o=(y==null?void 0:y.id)||null}const{data:a}=await n.from("open_game_players").select("position").eq("game_id",e.gameId).eq("status","confirmed").order("position",{ascending:!1}).limit(1),m=a&&a.length>0?(a[0].position||0)+1:1,{error:l}=await n.from("open_game_players").insert({game_id:e.gameId,user_id:s,player_account_id:o,status:d,position:d==="confirmed"?m:null});if(l)return l.code==="23505"?{success:!1,status:d,error:"Já estás inscrito neste jogo"}:(console.error("[OpenGames] Error joining game:",l),{success:!1,status:d,error:l.message});if(d==="confirmed"){const{data:y}=await n.from("open_game_players").select("id").eq("game_id",e.gameId).eq("status","confirmed"),{data:g}=await n.from("open_games").select("max_players").eq("id",e.gameId).single();y&&g&&y.length>=g.max_players&&await n.from("open_games").update({status:"full"}).eq("id",e.gameId)}return await x(e.gameId),{success:!0,status:d}}async function W(e,r){const{data:{user:s}}=await n.auth.getUser(),_=(s==null?void 0:s.id)||r,{error:d}=await n.from("open_game_players").delete().eq("game_id",e).eq("user_id",_);return d?(console.error("[OpenGames] Error leaving game:",d),!1):(await n.from("open_games").update({status:"open"}).eq("id",e).eq("status","full"),await x(e),!0)}async function K(e){const{error:r}=await n.from("open_games").update({status:"cancelled"}).eq("id",e);if(r)return console.error("[OpenGames] Error cancelling game:",r),!1;try{await n.from("court_bookings").update({status:"cancelled"}).like("notes",`%ID: ${e}%`).eq("event_type","open_game")}catch{}return!0}async function Q(e){const{data:{user:r}}=await n.auth.getUser(),s=r==null?void 0:r.id;if(!s)return{success:!1,error:"Utilizador não autenticado"};const{data:_}=await n.from("player_accounts").select("id, user_id, name").eq("id",e.playerAccountId).single();if(!_)return{success:!1,error:"Jogador não encontrado"};const{data:d}=await n.from("open_game_players").select("id").eq("game_id",e.gameId).eq("player_account_id",e.playerAccountId).maybeSingle();if(d)return{success:!1,error:"Jogador já está no jogo"};const{data:o}=await n.from("open_game_players").select("position").eq("game_id",e.gameId).eq("status","confirmed").order("position",{ascending:!1}).limit(1),a=o&&o.length>0?(o[0].position||0)+1:1,{error:m}=await n.from("open_game_players").insert({game_id:e.gameId,user_id:_.user_id||s,player_account_id:_.id,status:"confirmed",position:a});if(m)return console.error("[OpenGames] Error adding player to game:",m),{success:!1,error:m.message};const{data:l}=await n.from("open_game_players").select("id").eq("game_id",e.gameId).eq("status","confirmed"),{data:y}=await n.from("open_games").select("max_players").eq("id",e.gameId).single();return l&&y&&l.length>=y.max_players&&await n.from("open_games").update({status:"full"}).eq("id",e.gameId),await x(e.gameId),{success:!0}}async function V(e){if(!e||e.length<2)return[];const{data:r,error:s}=await n.from("player_accounts").select("id, name, avatar_url, level, player_category, phone_number").ilike("name",`%${e}%`).order("name").limit(10);return s||!r?[]:r}export{Q as addPlayerToOpenGame,K as cancelOpenGame,N as createOpenGame,B as fetchClubsWithAvailability,z as fetchOpenGames,R as joinOpenGame,W as leaveOpenGame,V as searchPlayerAccounts};
